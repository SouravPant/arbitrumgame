<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARBITAP - Tap to Earn</title>

    <!-- Farcaster Mini App Metadata -->
    <meta name="fc:miniapp" content='{
      "version": "1",
      "imageUrl": "https://arbitrumgame.vercel.app/image.png",
      "button": {
        "title": "Play ARBITAP",
        "action": {
          "type": "launch_frame",
          "name": "ARBITAP",
          "url": "https://arbitrumgame.vercel.app",
          "splashImageUrl": "https://arbitrumgame.vercel.app/splash.png",
          "splashBackgroundColor": "#28a0f0"
        }
      }
    }' />

    <!-- Wagmi Integration -->
    <script src="wagmi-integration.js"></script>

    <style>
        :root {
            --primary-blue: #007AFF;
            --secondary-blue: #5AC8FA;
            --neon-cyan: #00FFFF;
            --neon-purple: #8A2BE2;
            --background: #000014;
            --surface: #1C1C1E;
            --surface-light: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --gold: #FFD700;
            --green: #30D158;
            --red: #FF3B30;
            --orange: #FF9500;
            /* Added for new styles */
            --notcoin-yellow: #FFD60A;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, var(--background) 0%, #001122 100%);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            user-select: none;
            overflow-x: hidden;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            max-width: 480px;
            margin: 0 auto;
        }

        /* Header with Balance and Level */
        .header {
            padding: 20px 20px 15px;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary-blue), var(--neon-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .wallet-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-address {
            font-size: 12px;
            color: var(--green);
            background: rgba(48, 209, 88, 0.1);
            padding: 4px 8px;
            border-radius: 8px;
            border: 1px solid rgba(48, 209, 88, 0.3);
        }

        .streak-indicator {
            font-size: 12px;
            background: var(--orange);
            color: #000;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 600;
        }

        .balance-display {
            text-align: center;
            margin-bottom: 15px;
        }

        .balance-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            margin-bottom: 5px;
        }

        .balance-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .level-section {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 16px;
            padding: 12px 16px;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .level-text {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-blue);
            min-width: 70px;
        }

        .level-progress {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--neon-cyan));
            border-radius: 4px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
        }

        .next-level {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Energy System */
        .energy-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
        }

        .energy-icon {
            font-size: 18px;
            animation: energyPulse 2s ease-in-out infinite;
        }

        .energy-bar {
            width: 140px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--green), var(--neon-cyan));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 100%;
        }

        .energy-text {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            min-width: 60px;
        }

        @keyframes energyPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Central Tap Section */
        .tap-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            min-height: 250px;
        }

        .tap-button {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--neon-cyan) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 20px 60px rgba(0, 122, 255, 0.4),
                0 0 0 4px rgba(255, 255, 255, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            border: none;
            outline: none;
            animation: tapButtonGlow 3s ease-in-out infinite;
        }

        .tap-button:active {
            transform: scale(0.95);
            animation: tapPulse 0.6s ease-out;
        }

        .tap-button.challenge-active {
            animation: challengeGlow 0.5s ease-in-out infinite alternate;
        }

        .tap-icon {
            font-size: 70px;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
            transition: transform 0.2s ease;
        }

        @keyframes tapButtonGlow {
            0%, 100% {
                box-shadow:
                    0 20px 60px rgba(0, 122, 255, 0.4),
                    0 0 0 4px rgba(255, 255, 255, 0.1),
                    inset 0 2px 0 rgba(255, 255, 255, 0.2);
            }
            50% {
                box-shadow:
                    0 25px 80px rgba(0, 255, 255, 0.6),
                    0 0 0 6px rgba(0, 255, 255, 0.3),
                    inset 0 2px 0 rgba(255, 255, 255, 0.3);
            }
        }

        @keyframes tapPulse {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes challengeGlow {
            from {
                box-shadow:
                    0 20px 60px rgba(255, 165, 0, 0.6),
                    0 0 0 6px rgba(255, 165, 0, 0.4);
            }
            to {
                box-shadow:
                    0 25px 80px rgba(255, 215, 0, 0.8),
                    0 0 0 8px rgba(255, 215, 0, 0.6);
            }
        }

        /* Power-ups Section */
        .powerups-section {
            padding: 20px;
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            color: var(--text-primary);
        }

        .powerups-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 5px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .powerups-scroll::-webkit-scrollbar {
            display: none;
        }

        .powerup-card {
            min-width: 120px;
            background: rgba(44, 44, 46, 0.8);
            border-radius: 16px;
            padding: 16px 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .powerup-card:hover {
            transform: translateY(-4px);
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--primary-blue);
        }

        .powerup-card.affordable {
            border-color: var(--green);
            box-shadow: 0 0 20px rgba(48, 209, 88, 0.3);
            animation: affordableGlow 2s ease-in-out infinite;
        }

        @keyframes affordableGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(48, 209, 88, 0.3); }
            50% { box-shadow: 0 0 30px rgba(48, 209, 88, 0.5); }
        }

        .powerup-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .powerup-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .powerup-level {
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .powerup-cost {
            font-size: 11px;
            font-weight: 600;
            color: var(--gold);
        }

        /* Leaderboard Section - Positioned at bottom */
        .leaderboard-section {
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px 16px 0 0;
            margin: 0;
            margin-top: 20px;
            height: auto;
            max-height: 60px;
            display: flex;
            flex-direction: column;
            position: sticky;
            bottom: 0;
            transition: max-height 0.3s ease;
            overflow: hidden;
        }

        .leaderboard-section.expanded {
            max-height: 300px;
        }

        .leaderboard-toggle {
            width: 100%;
            background: rgba(44, 44, 46, 0.8);
            border: none;
            color: var(--text-primary);
            padding: 16px 20px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border-radius: 16px 16px 0 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-toggle:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 14px;
        }

        .leaderboard-toggle.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .leaderboard-content {
            flex: 1;
            height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            opacity: 0;
        }

        .leaderboard-content.expanded {
            height: 240px;
            opacity: 1;
            overflow-y: auto;
        }

        .leaderboard-list {
            padding: 0 20px 20px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(44, 44, 46, 0.6);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .leaderboard-item:hover {
            background: rgba(44, 44, 46, 0.8);
            transform: translateX(4px);
        }

        .leaderboard-item.current-player {
            background: linear-gradient(90deg, rgba(0, 122, 255, 0.2) 0%, rgba(44, 44, 46, 0.8) 100%);
            border-color: var(--primary-blue);
            box-shadow: 0 0 20px rgba(0, 122, 255, 0.3);
        }

        .leaderboard-item.rank-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2) 0%, rgba(44, 44, 46, 0.8) 100%);
            border-color: var(--gold);
        }

        .leaderboard-item.rank-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.2) 0%, rgba(44, 44, 46, 0.8) 100%);
            border-color: #C0C0C0;
        }

        .leaderboard-item.rank-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.2) 0%, rgba(44, 44, 46, 0.8) 100%);
            border-color: #CD7F32;
        }

        .rank-info {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 50px;
        }

        .rank {
            font-size: 16px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .player-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-blue), var(--neon-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .player-stats {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .player-score {
            font-size: 14px;
            color: var(--gold);
            font-weight: 700;
            text-align: right;
        }

        /* Animations for tap effects */
        .tap-popup {
            position: absolute;
            font-size: 24px;
            font-weight: 800;
            color: var(--gold);
            pointer-events: none;
            animation: popupFloat 1.5s ease-out forwards;
            z-index: 1000;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        }

        @keyframes popupFloat {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translateY(-40px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1);
            }
        }

        .tap-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--neon-cyan);
            border-radius: 50%;
            pointer-events: none;
            animation: particleExplode 1.2s ease-out forwards;
            box-shadow: 0 0 6px var(--neon-cyan);
        }

        @keyframes particleExplode {
            0% {
                opacity: 1;
                transform: scale(0) translateY(0);
            }
            50% {
                opacity: 1;
                transform: scale(1) translateY(-50px);
            }
            100% {
                opacity: 0;
                transform: scale(0) translateY(-80px);
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }

        .modal {
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
            border: 2px solid var(--primary-blue);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 320px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.8);
            animation: modalScale 0.3s ease forwards;
        }

        .modal h3 {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .modal p {
            font-size: 14px;
            margin-bottom: 20px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-button {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-button:hover {
            background: var(--secondary-blue);
            transform: translateY(-2px);
        }

        .modal-button.secondary {
            background: var(--surface-light);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @keyframes modalScale {
            to { transform: scale(1); }
        }

        /* Challenge Timer */
        .challenge-timer {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--orange);
            color: #000;
            padding: 12px 20px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 14px;
            z-index: 200;
            animation: challengeEnter 0.5s ease;
            box-shadow: 0 8px 25px rgba(255, 165, 0, 0.4);
        }

        @keyframes challengeEnter {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }



        /* Badge Notification */
        .badge-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5) rotateY(90deg);
            background: linear-gradient(135deg, var(--neon-purple), var(--primary-blue));
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 1001;
            animation: badgePopup 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            box-shadow: 0 20px 60px rgba(138, 43, 226, 0.5);
        }

        @keyframes badgePopup {
            0% {
                transform: translate(-50%, -50%) scale(0.5) rotateY(90deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1) rotateY(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotateY(0deg);
                opacity: 1;
            }
        }

        /* Added Styles for Secrets Section */
        .content-section {
            padding: 20px;
            margin-bottom: 20px;
        }

        .content-section h2 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 22px;
            font-weight: 800;
        }

        .content-section p {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        .env-setup {
            background: rgba(255,255,255,0.05);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }

        .env-item {
            margin-bottom: 20px;
        }

        .env-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--notcoin-yellow);
        }

        .env-item input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .env-item input:focus {
            outline: none;
            border-color: var(--notcoin-yellow);
        }

        .env-item small {
            display: block;
            margin-top: 4px;
            color: rgba(255,255,255,0.6);
            font-size: 12px;
        }

        .env-status {
            margin: 20px 0;
            padding: 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .env-status #envStatus {
            color: var(--notcoin-yellow);
            font-weight: 600;
        }

        .mint-button {
            background: var(--notcoin-yellow);
            color: #1f1f1f;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 214, 10, 0.3);
        }

        .mint-button:hover {
            background: #f0c400;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 214, 10, 0.4);
        }

        .mint-button.secondary {
            background: rgba(255,255,255,0.1);
            margin-left: 10px;
        }

        .mint-button.secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .github-setup {
            background: rgba(0,123,255,0.05);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(0,123,255,0.2);
        }

        .github-setup h3 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
        }

        .deployment-steps {
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .step-number {
            background: var(--notcoin-yellow);
            color: #1f1f1f;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .step-content strong {
            color: var(--notcoin-yellow);
            display: block;
            margin-bottom: 4px;
            font-size: 16px;
            font-weight: 700;
        }

        .step-content p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
        }

        .terminal-commands h4 {
            color: #00d4ff;
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 700;
        }

        .command-block {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .command-block code {
            flex-grow: 1;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-wrap: break-word;
            word-wrap: break-word;
            hyphens: auto;
        }

        .command-block button {
            background: var(--notcoin-yellow);
            color: #1f1f1f;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 12px;
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .command-block button:hover {
            transform: scale(1.05);
        }

        /* Responsive Design */
        @media (max-width: 360px) {
            .container {
                max-width: 100%;
            }

            .header {
                padding: 15px;
            }

            .app-title {
                font-size: 20px;
            }

            .balance-value {
                font-size: 28px;
            }

            .tap-button {
                width: 160px;
                height: 160px;
            }

            .tap-icon {
                font-size: 60px;
            }

            .powerups-scroll {
                gap: 8px;
            }

            .powerup-card {
                min-width: 100px;
                padding: 12px 8px;
            }

            /* Responsive adjustments for secrets section */
            .env-setup, .github-setup {
                padding: 16px;
            }

            .step {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .step-number {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .command-block {
                flex-direction: column;
                align-items: center;
            }

            .command-block code {
                margin-bottom: 10px;
                text-align: center;
            }

            .command-block button {
                margin-left: 0;
            }
        }

        /* Added Contract Status Styles */
        .wallet-info .contract-status {
            margin-top: 10px;
            text-align: center;
        }

        .wallet-info #deployBtn {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .wallet-info #deployBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 107, 53, 0.3);
        }

        .wallet-info #deployBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .wallet-info #contractAddress {
            display: block;
            font-size: 10px;
            color: #666;
            margin-top: 5px;
        }

        /* Loading indicator within power-up cards */
        .powerup-card .loading {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Balance and Level -->
        <div class="header">
            <div class="header-top">
                <div class="app-title">ARBITAP</div>
                <div class="wallet-info">
                    <div id="farcasterStatus" class="farcaster-status">🔵 Running in Browser</div>
                    <div id="walletStatus" class="wallet-status">Connect Wallet</div>
                    <div id="contractStatus" class="contract-status">
                        <button onclick="deployContract()" id="deployBtn">Deploy Contract</button>
                        <span id="contractAddress"></span>
                    </div>
                </div>
            </div>

            <div class="balance-display">
                <div class="balance-value" id="totalTaps">0</div>
                <div class="balance-label">Total Taps</div>
            </div>

            <div class="level-section">
                <div class="level-text" id="currentLevel">Level 1</div>
                <div class="level-progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="next-level" id="nextLevel">Level 2</div>
            </div>

            <div class="energy-section">
                <span class="energy-icon">⚡</span>
                <div class="energy-bar">
                    <div class="energy-fill" id="energyFill"></div>
                </div>
                <span class="energy-text" id="energyText">1000/1000</span>
            </div>
        </div>

        <!-- Central Tap Section -->
        <div class="tap-section">
            <button class="tap-button" id="tapButton">
                <div class="tap-icon">⚡</div>
            </button>
        </div>

        <!-- Power-ups Section -->
        <div class="powerups-section">
            <div class="section-title">⚡ Power-ups</div>
            <div class="powerups-scroll">
                <div class="powerup-card" id="tapPowerUpgrade">
                    <div class="powerup-icon">👆</div>
                    <div class="powerup-name">Tap Power</div>
                    <div class="powerup-level">Level <span id="tapPowerLevel">1</span></div>
                    <div class="powerup-cost"><span id="tapPowerCost">100</span> taps</div>
                </div>
                <div class="powerup-card" id="energyUpgrade">
                    <div class="powerup-icon">🔋</div>
                    <div class="powerup-name">Max Energy</div>
                    <div class="powerup-level">Level <span id="energyLevel">1</span></div>
                    <div class="powerup-cost"><span id="energyCost">200</span> taps</div>
                </div>
                <div class="powerup-card" id="regenUpgrade">
                    <div class="powerup-icon">⚡</div>
                    <div class="powerup-name">Energy Regen</div>
                    <div class="powerup-level">Level <span id="regenLevel">1</span></div>
                    <div class="powerup-cost"><span id="regenCost">300</span> taps</div>
                </div>
                <div class="powerup-card" id="levelUpgrade">
                    <div class="powerup-icon">⬆️</div>
                    <div class="powerup-name">Level Up</div>
                    <div class="powerup-level">Next: <span id="nextLevelCost">1000</span></div>
                    <div class="powerup-cost"><span id="levelUpCost">1000</span> taps</div>
                </div>
            </div>
        </div>

        <!-- Secrets Section -->
        <div id="secrets" class="content-section">
            <h2>🔐 Environment Setup</h2>
            <p>Configure your environment variables for blockchain integration.</p>

            <div class="env-setup">
                <div class="env-item">
                    <label>Private Key:</label>
                    <input type="password" id="privateKey" placeholder="Enter MetaMask private key" maxlength="64">
                    <small>Your MetaMask private key (without 0x prefix)</small>
                </div>
                <div class="env-item">
                    <label>Alchemy API Key:</label>
                    <input type="text" id="alchemyKey" placeholder="Enter Alchemy API key" maxlength="32">
                    <small>Get from alchemy.com for Arbitrum access</small>
                </div>
                <div class="env-item">
                    <label>Contract Address:</label>
                    <input type="text" id="contractAddress" placeholder="Enter deployed contract address" maxlength="42">
                    <small>Will be set after contract deployment</small>
                </div>
                <div class="env-status">
                    <div id="envStatus">Not configured</div>
                </div>
                <button class="mint-button" id="saveEnvBtn" onclick="saveEnvironment()">💾 Save Configuration</button>
                <button class="mint-button secondary" onclick="loadEnvironment()">📂 Load Saved</button>
                <button class="mint-button secondary" onclick="deployContract()">🚀 Deploy Contract</button>
            </div>


        </div>

        <!-- Leaderboard Section - Moved to bottom -->
        <div class="leaderboard-section">
            <button class="leaderboard-toggle" id="leaderboardToggle">
                <span>🏆 Global Leaderboard</span>
                <span class="toggle-icon">▼</span>
            </button>
            <div class="leaderboard-content" id="leaderboardContent">
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- Leaderboard items will be populated by JavaScript -->
                </div>
            </div>
        </div>


    </div>

    <!-- Game Script -->
    <script>
        // Game Configuration
        const LEVEL_REQUIREMENTS = [
            0, 100, 300, 600, 1000, 1500, 2100, 2800, 3600, 4500,
            5500, 6600, 7800, 9100, 10500, 12000, 13600, 15300, 17100, 19000,
            21000, 23100, 25300, 27600, 30000, 32500, 35100, 37800, 40600, 43500,
            46500, 49600, 52800, 56100, 59500, 63000, 66600, 70300, 74100, 78000
        ];

        const MILESTONE_BADGES = [10, 25, 50, 100, 200, 500, 1000];
        const TAP_MESSAGES = ['Boop!', 'Tap!', 'Arbitrum!', 'Zap!', '⚡', '💫', '🚀'];
        const CHALLENGE_TYPES = [
            { type: 'speed', target: 50, time: 10, reward: 100, message: 'Tap 50 times in 10 seconds!' },
            { type: 'speed', target: 30, time: 8, reward: 75, message: 'Tap 30 times in 8 seconds!' },
            { type: 'speed', target: 100, time: 15, reward: 200, message: 'Tap 100 times in 15 seconds!' }
        ];

        // Game State with localStorage persistence
        let gameState = {
            totalTaps: 0,
            currentLevel: 1,
            tapPower: 1,
            energy: 1000,
            maxEnergy: 1000,
            energyRegenRate: 1,
            totalEarned: 0,
            // Power-up levels
            tapPowerLevel: 1,
            energyLevel: 1,
            regenLevel: 1,
            // Power-up costs
            tapPowerCost: 100,
            energyCost: 200,
            regenCost: 300,
            levelUpCost: 1000,
            // Daily streak
            dailyStreak: 1,
            lastLoginDate: new Date().toDateString(),
            // Achievements
            unlockedBadges: [],
            // Current challenge
            currentChallenge: null,
            challengeTaps: 0,
            challengeStartTime: null
        };

        // Leaderboard data
        let leaderboardData = [
            { name: 'TapMaster_Pro', score: 1234567, level: 25, avatar: 'T' },
            { name: 'CryptoTapper', score: 987654, level: 22, avatar: 'C' },
            { name: 'ArbiKing', score: 765432, level: 19, avatar: 'A' },
            { name: 'Web3_Wizard', score: 542109, level: 16, avatar: 'W' },
            { name: 'DiamondHands', score: 298765, level: 13, avatar: 'D' },
            { name: 'MoonTapper', score: 187432, level: 11, avatar: 'M' }
        ];

        // DOM Elements
        let elements = {};

        // Initialize elements
        function initializeElements() {
            elements = {
                totalTaps: document.getElementById('totalTaps'),
                currentLevel: document.getElementById('currentLevel'),
                nextLevel: document.getElementById('nextLevel'),
                progressBar: document.getElementById('progressBar'),
                tapButton: document.getElementById('tapButton'),
                energyFill: document.getElementById('energyFill'),
                energyText: document.getElementById('energyText'),
                streakCount: document.getElementById('streakCount'),
                walletAddress: document.getElementById('walletAddress'),
                // Power-up elements
                tapPowerUpgrade: document.getElementById('tapPowerUpgrade'),
                energyUpgrade: document.getElementById('energyUpgrade'),
                regenUpgrade: document.getElementById('regenUpgrade'),
                levelUpgrade: document.getElementById('levelUpgrade'),
                tapPowerLevel: document.getElementById('tapPowerLevel'),
                energyLevel: document.getElementById('energyLevel'),
                regenLevel: document.getElementById('regenLevel'),
                nextLevelCost: document.getElementById('nextLevelCost'),
                tapPowerCost: document.getElementById('tapPowerCost'),
                energyCost: document.getElementById('energyCost'),
                regenCost: document.getElementById('regenCost'),
                levelUpCost: document.getElementById('levelUpCost'),
                // Leaderboard
                leaderboardToggle: document.getElementById('leaderboardToggle'),
                leaderboardContent: document.getElementById('leaderboardContent'),
                leaderboardList: document.getElementById('leaderboardList'),
                // Secrets section elements
                privateKeyInput: document.getElementById('privateKey'),
                alchemyKeyInput: document.getElementById('alchemyKey'),
                contractAddressInput: document.getElementById('contractAddress'),
                envStatusElement: document.getElementById('envStatus'),
                saveEnvBtn: document.getElementById('saveEnvBtn'),
                deployBtn: document.getElementById('deployBtn'),
                contractAddressDisplay: document.getElementById('contractAddress')
            };
        }

        // LocalStorage functions
        function saveGameState() {
            localStorage.setItem('arbitapGameState', JSON.stringify(gameState));
        }

        function loadGameState() {
            const saved = localStorage.getItem('arbitapGameState');
            if (saved) {
                const parsedState = JSON.parse(saved);
                gameState = { ...gameState, ...parsedState };

                // Check daily streak
                const today = new Date().toDateString();
                if (gameState.lastLoginDate !== today) {
                    const lastLogin = new Date(gameState.lastLoginDate);
                    const todayDate = new Date(today);
                    const dayDiff = Math.floor((todayDate - lastLogin) / (1000 * 60 * 60 * 24));

                    if (dayDiff === 1) {
                        gameState.dailyStreak++;
                        showDailyStreakBonus();
                    } else if (dayDiff > 1) {
                        gameState.dailyStreak = 1;
                    }

                    gameState.lastLoginDate = today;
                    saveGameState();
                }
            }
        }

        // Format numbers
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Calculate level from taps
        function calculateLevel(taps) {
            for (let i = LEVEL_REQUIREMENTS.length - 1; i >= 0; i--) {
                if (taps >= LEVEL_REQUIREMENTS[i]) {
                    return i + 1;
                }
            }
            return 1;
        }

        // Calculate progress to next level
        function calculateProgress(taps, level) {
            if (level >= LEVEL_REQUIREMENTS.length) return 100;

            const currentReq = LEVEL_REQUIREMENTS[level - 1];
            const nextReq = LEVEL_REQUIREMENTS[level];
            const progress = ((taps - currentReq) / (nextReq - currentReq)) * 100;

            return Math.min(100, Math.max(0, progress));
        }

        // Update all UI elements
        function updateUI() {
            const newLevel = calculateLevel(gameState.totalTaps);
            const leveledUp = newLevel > gameState.currentLevel;

            if (leveledUp) {
                gameState.currentLevel = newLevel;
                gameState.tapPower = Math.max(gameState.tapPowerLevel, Math.floor(newLevel / 5) + 1);
                showLevelUpNotification(newLevel);

                // Check for milestone badges
                if (MILESTONE_BADGES.includes(newLevel) && !gameState.unlockedBadges.includes(newLevel)) {
                    gameState.unlockedBadges.push(newLevel);
                    showBadgeNotification(newLevel);
                }
            }

            // Update display elements
            if (elements.totalTaps) {
                elements.totalTaps.textContent = formatNumber(gameState.totalTaps);
            }

            if (elements.currentLevel) {
                elements.currentLevel.textContent = `Level ${gameState.currentLevel}`;
            }

            if (elements.nextLevel) {
                const nextLvl = gameState.currentLevel + 1;
                elements.nextLevel.textContent = nextLvl <= LEVEL_REQUIREMENTS.length ? `Level ${nextLvl}` : 'MAX';
            }

            if (elements.progressBar) {
                const progress = calculateProgress(gameState.totalTaps, gameState.currentLevel);
                elements.progressBar.style.width = progress + '%';
            }

            // Update energy
            if (elements.energyFill) {
                const energyPercent = (gameState.energy / gameState.maxEnergy) * 100;
                elements.energyFill.style.width = energyPercent + '%';
            }

            if (elements.energyText) {
                elements.energyText.textContent = `${Math.floor(gameState.energy)}/${gameState.maxEnergy}`;
            }

            // Update streak
            if (elements.streakCount) {
                elements.streakCount.textContent = gameState.dailyStreak;
            }

            // Update power-up UI
            updatePowerUpUI();
            updatePowerUpAffordability();
            updateLeaderboard();

            saveGameState();
        }

        // Update power-up UI
        function updatePowerUpUI() {
            if (elements.tapPowerLevel) elements.tapPowerLevel.textContent = gameState.tapPowerLevel;
            if (elements.energyLevel) elements.energyLevel.textContent = gameState.energyLevel;
            if (elements.regenLevel) elements.regenLevel.textContent = gameState.regenLevel;
            if (elements.nextLevelCost) elements.nextLevelCost.textContent = formatNumber(gameState.currentLevel + 1);
            if (elements.tapPowerCost) elements.tapPowerCost.textContent = formatNumber(gameState.tapPowerCost);
            if (elements.energyCost) elements.energyCost.textContent = formatNumber(gameState.energyCost);
            if (elements.regenCost) elements.regenCost.textContent = formatNumber(gameState.regenCost);
            if (elements.levelUpCost) elements.levelUpCost.textContent = formatNumber(gameState.levelUpCost);
        }

        // Update power-up affordability visual feedback
        function updatePowerUpAffordability() {
            const powerups = [
                { element: elements.tapPowerUpgrade, cost: gameState.tapPowerCost },
                { element: elements.energyUpgrade, cost: gameState.energyCost },
                { element: elements.regenUpgrade, cost: gameState.regenCost },
                { element: elements.levelUpgrade, cost: gameState.levelUpCost }
            ];

            powerups.forEach(({ element, cost }) => {
                if (element) {
                    if (gameState.totalTaps >= cost) {
                        element.classList.add('affordable');
                    } else {
                        element.classList.remove('affordable');
                    }
                }
            });
        }

        // Handle tap
        function handleTap() {
            if (gameState.energy < gameState.tapPower) return;

            gameState.energy -= gameState.tapPower;
            gameState.totalTaps += gameState.tapPower;
            gameState.totalEarned += gameState.tapPower;

            // Challenge progress
            if (gameState.currentChallenge) {
                gameState.challengeTaps += gameState.tapPower;
                updateChallengeProgress();
            }

            // Tap animations
            createTapPopup();
            createTapParticles();

            // Haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }

            updateUI();

            // Random challenge trigger (5% chance)
            if (!gameState.currentChallenge && Math.random() < 0.05 && gameState.totalTaps > 100) {
                startRandomChallenge();
            }
        }

        // Power-up purchase functions
        async function buyTapPowerUpgrade() {
            if (gameState.totalTaps >= gameState.tapPowerCost) {
                try {
                    // Show loading state
                    const upgradeBtn = document.querySelector('#tapPowerUpgrade');
                    const originalContent = upgradeBtn.innerHTML;
                    upgradeBtn.innerHTML = '<div class="loading">Confirming on Arbitrum...</div>';
                    upgradeBtn.style.pointerEvents = 'none';

                    // Call smart contract to update level
                    if (window.gameContract && window.gameContract.account) {
                        const result = await window.gameContract.updatePlayerLevel(
                            gameState.tapPowerLevel + 1,
                            gameState.totalTaps
                        );

                        if (result.success) {
                            // Only update game state after blockchain confirmation
                            gameState.totalTaps -= gameState.tapPowerCost;
                            gameState.tapPowerLevel++;
                            gameState.tapPower = gameState.tapPowerLevel;
                            gameState.tapPowerCost = Math.floor(gameState.tapPowerCost * 1.5);

                            showPowerUpNotification(`Level ${gameState.tapPowerLevel} Confirmed on Arbitrum!`);
                            showPowerUpNotification(`TX: ${result.txHash.substring(0, 10)}...`);
                            updateUI();
                            saveGameState();
                        } else {
                            throw new Error('Transaction failed');
                        }
                    } else {
                        throw new Error('Please connect your wallet first');
                    }

                    // Restore button
                    upgradeBtn.innerHTML = originalContent;
                    upgradeBtn.style.pointerEvents = 'auto';

                } catch (error) {
                    console.error('Upgrade failed:', error);

                    // Show error notification
                    showPowerUpNotification(`Upgrade failed: ${error.message}`);

                    // Restore button
                    const upgradeBtn = document.querySelector('#tapPowerUpgrade');
                    if (upgradeBtn) {
                         const loadingDiv = upgradeBtn.querySelector('.loading');
                         if (loadingDiv) loadingDiv.remove();
                    }
                    if(upgradeBtn) upgradeBtn.style.pointerEvents = 'auto';
                }
            } else {
                showPowerUpNotification('Not enough taps!');
            }
        }

        async function buyEnergyUpgrade() {
            if (gameState.totalTaps >= gameState.energyCost) {
                gameState.totalTaps -= gameState.energyCost;
                gameState.energyLevel++;
                gameState.maxEnergy = 1000 + (gameState.energyLevel - 1) * 200;
                gameState.energy = gameState.maxEnergy;
                gameState.energyCost = Math.floor(gameState.energyCost * 1.5);

                showPowerUpNotification('Max Energy', gameState.energyLevel);
                updateUI();
            }
        }

        async function buyRegenUpgrade() {
            if (gameState.totalTaps >= gameState.regenCost) {
                gameState.totalTaps -= gameState.regenCost;
                gameState.regenLevel++;
                gameState.energyRegenRate = gameState.regenLevel;
                gameState.regenCost = Math.floor(gameState.regenCost * 1.5);

                showPowerUpNotification('Energy Regen', gameState.regenLevel);
                updateUI();
            }
        }

        async function buyLevelUpgrade() {
            // Check if user has enough taps
            if (gameState.totalTaps < gameState.levelUpCost) {
                showModal('❌ Insufficient Taps', `You need ${formatNumber(gameState.levelUpCost)} taps to upgrade to level ${gameState.currentLevel + 1}.`);
                return;
            }

            // Check wallet connection
            if (!window.gameContract || !window.gameContract.account) {
                showModal('🔗 Wallet Required', 'Please connect your MetaMask wallet to upgrade levels on Arbitrum blockchain.', [
                    { text: 'Connect Wallet', action: 'connectWallet()' },
                    { text: 'Cancel', action: null }
                ]);
                return;
            }

            // Check contract address
            if (!window.gameContract.contractAddress) {
                showModal('⚙️ Contract Not Configured', 'Please configure the game contract address in the Environment Setup section.', [
                    { text: 'Go to Setup', action: 'scrollToSetup()' },
                    { text: 'Cancel', action: null }
                ]);
                return;
            }

            const nextLevel = gameState.currentLevel + 1;

            try {
                // Show confirmation modal first
                showModal(
                    '🚀 Confirm Level Upgrade',
                    `This will upgrade you to Level ${nextLevel} and cost ${formatNumber(gameState.levelUpCost)} taps. You will need to approve this transaction in your wallet.`,
                    [
                        { text: 'Confirm & Upgrade', action: 'confirmLevelUpgrade()' },
                        { text: 'Cancel', action: null }
                    ]
                );
            } catch (error) {
                console.error('Level upgrade initiation failed:', error);
                showModal('❌ Level Up Failed', 'Failed to initiate level upgrade. Please try again.');
            }
        }

        async function confirmLevelUpgrade() {
            const nextLevel = gameState.currentLevel + 1;

            try {
                // Close confirmation modal
                const modal = document.querySelector('.modal-overlay');
                if (modal) modal.remove();

                // Show processing state
                showModal('⏳ Processing Level Up...', 'Please approve the transaction in your wallet. This may take a few moments...', []);

                // Call smart contract to update level
                const result = await window.gameContract.updatePlayerLevel(nextLevel, gameState.totalTaps);

                if (result.success) {
                    // Deduct taps and update level
                    gameState.totalTaps -= gameState.levelUpCost;
                    gameState.currentLevel = nextLevel;
                    gameState.levelUpCost = Math.floor(gameState.levelUpCost * 1.8);

                    // Close processing modal
                    const processingModal = document.querySelector('.modal-overlay');
                    if (processingModal) processingModal.remove();

                    // Show success modal with transaction details
                    showModal(
                        '🎉 Level Up Successful!',
                        `Congratulations! You are now Level ${nextLevel}.<br><br>Transaction Hash: <br><small>${result.txHash}</small><br><br>Gas Used: ${result.gasUsed || 'N/A'}`,
                        [
                            { text: 'View on Arbiscan', action: `window.open('https://arbiscan.io/tx/${result.txHash}', '_blank')` },
                            { text: 'Continue', action: null }
                        ]
                    );

                    updateUI();
                    saveGameState();
                }
            } catch (error) {
                console.error('Level upgrade failed:', error);

                // Close any existing modals
                const existingModal = document.querySelector('.modal-overlay');
                if (existingModal) existingModal.remove();

                // Show specific error message
                let errorMessage = 'Transaction failed. Please try again.';
                if (error.message.includes('rejected')) {
                    errorMessage = 'Transaction was rejected. Level upgrade cancelled.';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage = 'Insufficient ETH for gas fees. Please add more ETH to your wallet.';
                } else if (error.message.includes('Contract address not configured')) {
                    errorMessage = 'Game contract not configured. Please set up the contract address.';
                }

                showModal('❌ Level Up Failed', errorMessage, [
                    { text: 'Try Again', action: 'buyLevelUpgrade()' },
                    { text: 'Cancel', action: null }
                ]);
            }
        }

        // Helper functions
        function connectWallet() {
            if (window.gameContract) {
                window.gameContract.setupRegularWallet();
            }
        }

        function scrollToSetup() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
            document.getElementById('secrets').scrollIntoView({ behavior: 'smooth' });
        }

        // Challenge system
        function startRandomChallenge() {
            const challenge = CHALLENGE_TYPES[Math.floor(Math.random() * CHALLENGE_TYPES.length)];
            gameState.currentChallenge = challenge;
            gameState.challengeTaps = 0;
            gameState.challengeStartTime = Date.now();

            elements.tapButton.classList.add('challenge-active');
            showChallengeTimer(challenge);
        }

        function showChallengeTimer(challenge) {
            const timer = document.createElement('div');
            timer.className = 'challenge-timer';
            timer.innerHTML = `
                <div>${challenge.message}</div>
                <div>Reward: ${challenge.reward} taps</div>
                <div id="challengeCountdown">${challenge.time}s</div>
            `;
            document.body.appendChild(timer);

            const countdown = document.getElementById('challengeCountdown');
            const interval = setInterval(() => {
                const elapsed = (Date.now() - gameState.challengeStartTime) / 1000;
                const remaining = Math.max(0, challenge.time - elapsed);
                countdown.textContent = `${remaining.toFixed(1)}s`;

                if (remaining <= 0) {
                    clearInterval(interval);
                    endChallenge(timer, false);
                }
            }, 100);
        }

        function updateChallengeProgress() {
            if (!gameState.currentChallenge) return;

            const challenge = gameState.currentChallenge;
            if (gameState.challengeTaps >= challenge.target) {
                endChallenge(document.querySelector('.challenge-timer'), true);
            }
        }

        function endChallenge(timerElement, success) {
            if (success) {
                gameState.totalTaps += gameState.currentChallenge.reward;
                showModal('🎉 Challenge Complete!', `You earned ${gameState.currentChallenge.reward} bonus taps!`);
            }

            gameState.currentChallenge = null;
            gameState.challengeTaps = 0;
            gameState.challengeStartTime = null;
            elements.tapButton.classList.remove('challenge-active');

            if (timerElement) {
                timerElement.remove();
            }

            updateUI();
        }

        // Notification functions
        function showLevelUpNotification(level) {
            const notification = document.createElement('div');
            notification.className = 'modal-overlay';
            notification.innerHTML = `
                <div class="modal">
                    <h3>🎉 Level Up!</h3>
                    <p>Welcome to Level ${level}</p>
                    <p>Tap Power: ${gameState.tapPower}</p>
                    <div class="modal-buttons">
                        <button class="modal-button" onclick="this.closest('.modal-overlay').remove()">Awesome!</button>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        function showPowerUpNotification(powerName, level) {
            const notification = document.createElement('div');
            notification.className = 'modal-overlay';
            notification.innerHTML = `
                <div class="modal">
                    <h3>🚀 Power-up Upgraded!</h3>
                    <p>${powerName} ${level ? `Level ${level}` : ''}</p>
                    <div class="modal-buttons">
                        <button class="modal-button" onclick="this.closest('.modal-overlay').remove()">Great!</button>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 2000);
        }

        function showBadgeNotification(level) {
            const notification = document.createElement('div');
            notification.className = 'badge-notification';
            notification.innerHTML = `
                <h3>🏆 Milestone Badge Unlocked!</h3>
                <p>Level ${level} Achievement</p>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'fadeOut 0.5s ease-in';
                    setTimeout(() => notification.remove(), 500);
                }
            }, 3000);
        }

        function showDailyStreakBonus() {
            const bonus = gameState.dailyStreak * 10;
            gameState.totalTaps += bonus;

            showModal('🔥 Daily Streak Bonus!', `${gameState.dailyStreak} day streak! You earned ${bonus} bonus taps!`);
        }

        function showModal(title, message, buttons = [{ text: 'OK', action: null }]) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';

            const buttonHtml = buttons.map(btn =>
                `<button class="modal-button" onclick="${btn.action || 'this.closest(\'.modal-overlay\').remove()'}">${btn.text}</button>`
            ).join('');

            modal.innerHTML = `
                <div class="modal">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <div class="modal-buttons">
                        ${buttonHtml}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Create tap popup
        function createTapPopup() {
            const popup = document.createElement('div');
            popup.className = 'tap-popup';
            popup.textContent = TAP_MESSAGES[Math.floor(Math.random() * TAP_MESSAGES.length)];

            const buttonRect = elements.tapButton.getBoundingClientRect();
            const x = buttonRect.left + (Math.random() * buttonRect.width);
            const y = buttonRect.top + (Math.random() * buttonRect.height);

            popup.style.left = x + 'px';
            popup.style.top = y + 'px';

            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1500);
        }

        // Create tap particles
        function createTapParticles() {
            const buttonRect = elements.tapButton.getBoundingClientRect();
            const centerX = buttonRect.left + buttonRect.width / 2;
            const centerY = buttonRect.top + buttonRect.height / 2;

            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'tap-particle';

                const angle = (i / 8) * 2 * Math.PI;
                const distance = 50 + Math.random() * 40;
                const x = centerX + Math.cos(angle) * distance;
                const y = centerY + Math.sin(angle) * distance;

                particle.style.left = x + 'px';
                particle.style.top = y + 'px';

                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1200);
            }
        }

        // Update leaderboard
        function updateLeaderboard() {
            if (!elements.leaderboardList) return;

            // Add current player to leaderboard
            const playerData = {
                name: 'You',
                score: gameState.totalTaps,
                level: gameState.currentLevel,
                avatar: 'Y',
                isCurrentPlayer: true
            };

            const allPlayers = [...leaderboardData, playerData].sort((a, b) => b.score - a.score);

            elements.leaderboardList.innerHTML = allPlayers.map((player, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const currentPlayerClass = player.isCurrentPlayer ? 'current-player' : '';

                return `
                    <div class="leaderboard-item ${rankClass} ${currentPlayerClass}">
                        <div class="rank-info">
                            <div class="rank">${rank}</div>
                            ${rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : ''}
                        </div>
                        <div class="player-avatar">${player.avatar}</div>
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-stats">Level ${player.level}</div>
                        </div>
                        <div class="player-score">${formatNumber(player.score)}</div>
                    </div>
                `;
            }).join('');
        }

        // Energy regeneration
        function startEnergyRegen() {
            setInterval(() => {
                if (gameState.energy < gameState.maxEnergy) {
                    gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + gameState.energyRegenRate);
                    updateUI();
                }
            }, 1000);
        }

        // Secrets management functions
        function saveEnvironment() {
            const privateKey = elements.privateKeyInput.value;
            const alchemyKey = elements.alchemyKeyInput.value;
            const contractAddress = elements.contractAddressInput.value;

            if (!privateKey || !alchemyKey) {
                showNotification('Please fill in all required fields!', 'error');
                return;
            }

            // Validate private key format (simple check for common lengths)
            if (privateKey.length !== 64 && privateKey.length !== 66) {
                showNotification('Invalid private key format! Ensure it is 64 or 66 characters long.', 'error');
                return;
            }

            // Validate contract address format
            if (contractAddress && (!contractAddress.startsWith('0x') || contractAddress.length !== 42)) {
                showNotification('Invalid contract address format! Should be 42 characters starting with 0x.', 'error');
                return;
            }

            // Save to localStorage (for demo purposes)
            localStorage.setItem('gamePrivateKey', privateKey);
            localStorage.setItem('gameAlchemyKey', alchemyKey);
            localStorage.setItem('gameContractAddress', contractAddress);

            // Update contract address in gameContract instance
            if (window.gameContract && contractAddress) {
                window.gameContract.contractAddress = contractAddress;
                updateContractStatusDisplay();
            }

            updateEnvStatus();
            showNotification('✅ Environment variables saved successfully!', 'success');
        }

        function loadEnvironment() {
            const privateKey = localStorage.getItem('gamePrivateKey');
            const alchemyKey = localStorage.getItem('gameAlchemyKey');
            const contractAddress = localStorage.getItem('gameContractAddress');

            if (privateKey) elements.privateKeyInput.value = privateKey;
            if (alchemyKey) elements.alchemyKeyInput.value = alchemyKey;
            if (contractAddress) {
                elements.contractAddressInput.value = contractAddress;
                if (window.gameContract) {
                    window.gameContract.contractAddress = contractAddress;
                    updateContractStatusDisplay();
                }
            }

            updateEnvStatus();
            showNotification('Environment variables loaded!', 'success');
        }

        function updateEnvStatus() {
            const privateKey = localStorage.getItem('gamePrivateKey');
            const alchemyKey = localStorage.getItem('gameAlchemyKey');

            if (privateKey && alchemyKey) {
                elements.envStatusElement.textContent = '✅ Configured and ready for deployment';
                elements.envStatusElement.style.color = '#10b981';
            } else {
                elements.envStatusElement.textContent = '❌ Not configured';
                elements.envStatusElement.style.color = '#ef4444';
            }
        }

        function deployContract() {
            const privateKey = localStorage.getItem('gamePrivateKey');
            const alchemyKey = localStorage.getItem('gameAlchemyKey');

            if (!privateKey || !alchemyKey) {
                showNotification('Please configure environment variables first!', 'error');
                return;
            }

            // Show confirmation modal before deployment
            showModal('Confirm Deployment', 'Are you sure you want to deploy the contract? This will cost gas fees.', [
                { text: 'Deploy', action: 'startContractDeployment()' },
                { text: 'Cancel', action: null }
            ]);
        }

        async function startContractDeployment() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();

            if (!window.gameContract || !window.gameContract.account) {
                showPowerUpNotification('Please connect wallet first');
                return;
            }

            try {
                const deployBtn = document.getElementById('deployBtn');
                deployBtn.textContent = 'Deploying...';
                deployBtn.disabled = true;

                // Deploy contract using ethers.js
                await window.gameContract.loadEthersLibrary();

                const contractABI = [
                    {
                        "inputs": [],
                        "stateMutability": "nonpayable",
                        "type": "constructor"
                    },
                    {
                        "inputs": [{"internalType": "uint256", "name": "newLevel", "type": "uint256"}],
                        "name": "updateLevel",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    }
                ];

                const contractBytecode = "0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610c1f806100606000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c80633a9b1cbe1461003b578063893d20e814610057575b600080fd5b61005560048036038101906100509190610175565b610075565b005b61005f6100d8565b60405161006c91906101b1565b60405180910390f35b6000546100889060019060a0900460ff16565b156100c8576040517f08c379a00000000000000000000000000000000000000000000000000081526004016100bf90610219565b60405180910390fd5b8060018190555050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000808fd5b6000819050919050565b61011281610108565b811461011d57600080fd5b50565b60008135905061012f81610109565b92915050565b60006020828403121561014b5761014a610103565b5b600061015984828501610120565b91505092915050565b61016b81610108565b82525050565b6000602082019050610186600083018461016262565b92915050565b60006101b78261018c565b9050919050565b6101c7816101ac565b82525050565b60006101d8826101e8565b9050919050565b60006101ea826101f9565b9050919050565b6000819050919050565b7f4e6f7420617574686f72697a656400000000000000000000000000000000000600008201525050565b6000610233600f836101f9565b915061023e82610213565b602082019050919050565b6000602082019050818103600083015261026281610226565b9050919050565b60006101b78261018c565b9050919050565b6101c7816101ac565b82525050565b60006101d8826101e8565b9050919050565b60006101ea826101f9565b9050919050565b6000819050919050565b7f4e6f7420617574686f72697a656400000000000000000000000000000000000600008201525050565b6000610233600f836101f9565b915061023e82610213565b602082019050919050565b6000602082019050818103600083015261026281610226565b905091905056fea26469706673582212209d5e7f1c8b9c5a2d4e6f7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f90064736f6c63430008140033";

                const signer = new window.ethers.providers.Web3Provider(window.ethereum).getSigner();
                const contractFactory = new window.ethers.ContractFactory(contractABI, contractBytecode, signer);

                const contract = await contractFactory.deploy();
                await contract.deployed();

                const contractAddress = contract.address;
                console.log('Contract deployed to:', contractAddress);

                // Save contract address
                localStorage.setItem('gameContractAddress', contractAddress);
                window.gameContract.contractAddress = contractAddress;

                // Update UI
                updateContractStatusDisplay();
                deployBtn.textContent = 'Deployed!';
                deployBtn.style.backgroundColor = '#4CAF50';

                showPowerUpNotification(`Contract deployed! ${contractAddress.substring(0, 10)}...`);

            } catch (error) {
                console.error('Deployment failed:', error);
                showPowerUpNotification(`Deployment failed: ${error.message}`);

                const deployBtn = document.getElementById('deployBtn');
                deployBtn.textContent = 'Deploy Contract';
                deployBtn.disabled = false;
            }
        }

        function updateContractStatusDisplay() {
            const contractAddress = localStorage.getItem('gameContractAddress');
            if (contractAddress) {
                elements.contractAddressDisplay.textContent = `Contract: ${contractAddress.substring(0, 8)}...`;
                elements.deployBtn.textContent = 'Deployed';
                elements.deployBtn.disabled = true;
                elements.deployBtn.style.backgroundColor = '#4CAF50';
            } else {
                elements.contractAddressDisplay.textContent = '';
                elements.deployBtn.textContent = 'Deploy Contract';
                elements.deployBtn.disabled = false;
                elements.deployBtn.style.backgroundColor = '';
            }
        }

        function copyCommand(command) {
            navigator.clipboard.writeText(command).then(() => {
                showNotification('📋 Command copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy command', 'error');
            });
        }

        // Helper for showing generic notifications (e.g., for copy command, save env)
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }


        // Initialize game
        function initializeGame() {
            loadGameState();
            initializeElements();

            // Load environment variables and update UI
            loadEnvironment();

            // Set up event listeners
            if (elements.tapButton) {
                elements.tapButton.addEventListener('click', handleTap);
                elements.tapButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    handleTap();
                });
            }

            // Power-up event listeners
            if (elements.tapPowerUpgrade) elements.tapPowerUpgrade.addEventListener('click', buyTapPowerUpgrade);
            if (elements.energyUpgrade) elements.energyUpgrade.addEventListener('click', buyEnergyUpgrade);
            if (elements.regenUpgrade) elements.regenUpgrade.addEventListener('click', buyRegenUpgrade);
            if (elements.levelUpgrade) elements.levelUpgrade.addEventListener('click', buyLevelUpgrade);

            // Leaderboard toggle
            if (elements.leaderboardToggle) {
                elements.leaderboardToggle.addEventListener('click', () => {
                    const leaderboardSection = document.querySelector('.leaderboard-section');
                    elements.leaderboardToggle.classList.toggle('expanded');
                    elements.leaderboardContent.classList.toggle('expanded');
                    leaderboardSection.classList.toggle('expanded');
                });
            }

            // Start systems
            startEnergyRegen();

            // Initial UI update
            updateUI();

            console.log('Enhanced ArbiTap game initialized with persistence and new features');
        }

        // Initialize environment status on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded - initializing enhanced ArbiTap game...');
            initializeGame();
        });

        // Listen for wallet connection updates
        window.addEventListener('walletConnected', (event) => {
            if (elements.walletAddress) {
                elements.walletAddress.textContent = `${event.detail.address.slice(0, 6)}...${event.detail.address.slice(-4)}`;
                elements.walletAddress.className = 'wallet-address wallet-connected';
            }
            // Enable deploy button if wallet is connected
            if (elements.deployBtn) {
                elements.deployBtn.disabled = false;
            }
        });

        window.addEventListener('walletDisconnected', () => {
            if (elements.walletAddress) {
                elements.walletAddress.textContent = 'Connect Wallet';
                elements.walletAddress.className = 'wallet-address';
            }
            // Disable deploy button if wallet is disconnected
            if (elements.deployBtn) {
                elements.deployBtn.disabled = true;
            }
        });

        // Auto-save every 30 seconds
        setInterval(() => {
            saveGameState();
        }, 30000);

        // Save on page unload
        window.addEventListener('beforeunload', () => {
            saveGameState();
        });
    </script>
</body>
</html>